# 🚀 10x-Agent-Loop

**突破 Cursor / Windsurf 配额限制，实现真正的自主编程循环。**

[中文](readme-zh.md) | [English](readme.md)

---

很多时候，你的 Agent 因为 Fast Request 配额耗尽而被迫停止，或者因为上下文污染（Context Pollution）而陷入死循环。

**10x-Agent-Loop** 通过文件监听技术和多运行时支持，为你带来：

*   💰 **无限续杯**：一次 Fast Request，无限次交互，让你的 500 次配额像 5000 次一样耐用。
*   🧠 **咨询师模式**：当 AI 卡住时，自动生成结构化求助邮件，引入外部最强大脑（Gemini/Claude）破局。
*   🛡️ **上下文清洗**：强制结构化思考，防止 Agent 陷入局部最优解。

> **⚠️ 前置要求**：
> 1. 以下任一运行时（优先使用系统自带版本，无需安装）：
>    *   PowerShell (Windows 内置)
>    *   CMD (Windows 内置)
>    *   Bash (Linux/macOS 内置)
>    *   [Bun](https://bun.sh/) (需安装)
>    *   [Node.js](https://nodejs.org/) (v16+，需安装)
>    *   [Python](https://www.python.org/) (v3.6+，需安装)
> 2. **⚠️ 重要**：使用 Cursor 或 Windsurf 的 **Composer Agent 模式**（不是普通聊天模式）。本方案仅在 Agent 模式下有效，因为需要 AI 能够执行终端命令。

---

## ⚡️ 快速开始 (Quick Start)

**核心原理**：1. **脚本**负责挂起进程；2. **规则**负责告诉 AI 去运行脚本。

```
┌──────┐    ┌──────────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 用户 │───>│Cursor Composer│───>│ 规则文件 │───>│AI执行任务│───>│ 运行脚本 │
└──────┘    │ (Agent 模式)  │    │cursor-rules│    └────┬───┘    │ask-followup│
            └──────────────┘    └──────────┘           │         └─────┬────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │  文件监听    │
                                                       │         │NEXT_STEP.md  │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │用户输入指令  │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       └────────────────┘
                                                                  │
                                                                  ▼
                                                           ┌──────────────┐
                                                           │AI 继续工作   │
                                                           └──────┬───────┘
                                                                  │
                                                                  └──> (循环继续...)
```

### 1. 部署文件

请将对应文件直接复制到你的项目。**所有版本功能相同，选择适合你环境的一种即可**。

| 你的环境 | 复制脚本（到项目根目录） | 复制规则（到 `.cursor/rules/` 或根目录） |
| :--- | :--- | :--- |
| **Windows**（推荐，系统自带） | `files/pwsh/ask-followup.ps1` | `files/pwsh/cursor-rules.mdc` |
| **Mac / Linux**（系统自带） | `files/shell/ask-followup.sh` | `files/shell/cursor-rules.mdc` |
| **Node.js** | `files/node/ask-followup.js` | `files/node/cursor-rules.mdc` |
| **Python** | `files/python/ask-followup.py` | `files/python/cursor-rules.mdc` |
| **Bun** | `files/bun/ask-followup.ts` | `files/bun/cursor-rules.mdc` |

> ⚠️ **重要**：请**直接复制文件本身**。手动新建文件粘贴可能会导致**编码格式 (UTF-8/BOM) 或换行符 (CRLF/LF)** 问题，导致脚本无法执行。
>
> **规则文件位置说明**：
> - Cursor 新版推荐：复制到 `.cursor/rules/` 目录（确保 Cursor 设置中的 "Rules for AI" 已启用）
> - 或根目录：复制到项目根目录并命名为 `.cursorrules`
>
> **Linux/Mac 用户**：请记得赋予脚本执行权限：`chmod +x ask-followup.sh`

### 2. 开始循环

```
┌──────────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│打开 Composer │──>│输入需求  │──>│AI执行任务│──>│AI运行脚本│──>│显示进度条│
│  (Ctrl+I)    │   └──────────┘   └──────────┘   │ask-followup│  │Spinning..│
└──────────────┘                                 └─────┬──────┘   └─────┬────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │生成NEXT_STEP │
                                                       │         │    .md       │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │用户编辑文件   │
                                                       │         │输入指令       │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │  保存文件     │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │AI检测到变化  │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       │                ▼
                                                       │         ┌──────────────┐
                                                       │         │   继续?       │
                                                       │         └──────┬───────┘
                                                       │                │
                                                       │        ┌──────┴──────┐
                                                       │        │              │
                                                       │        ▼              ▼
                                                       │   ┌────────┐    ┌──────────┐
                                                       │   │  是    │    │   否      │
                                                       │   └───┬────┘    └─────┬────┘
                                                       │       │              │
                                                       │       │              ▼
                                                       │       │         ┌──────────┐
                                                       │       │         │结束循环  │
                                                       │       │         └──────────┘
                                                       │       │
                                                       │       └──> (返回 AI 执行任务)
```

**步骤说明**：
1. 打开 Cursor Composer (`Ctrl+I` / `Cmd+I`)，**确保处于 Agent 模式**。
2. 输入需求，**确保 AI 引用了规则文件**（可手动输入 `@cursor-rules.mdc` 确认）。
3. AI 完成任务后会自动运行脚本，终端出现 **Spinning（进度条）**。
4. 打开根目录生成的 `NEXT_STEP.md`，输入指令并**保存**。
5. AI 自动唤醒，继续工作。

### 3. 如何停止

- **正常结束**：在 `NEXT_STEP.md` 中输入 `stop` 或 `结束`，AI 会正常退出循环。
- **强制终止**：在终端按 `Ctrl+C` 终止脚本进程。

---

## 🧠 设计哲学 (Why This Matters)

### 1. 为什么要"写邮件"？(Context Cleaning)

这是一个反直觉的设计。我们在 IDE 里直接对话不好吗？

**核心哲学：上下文清洗 (Context Cleaning)**

与其说是为了"求助"，不如说是为了**"降噪"**。

*   **摆脱 Agent 框架束缚**：类似 Cursor 的 IDE 编程工具中，LLM 实际还会被传入大量的系统提示词（System Prompts）、工具定义（Tool Definitions）、角色定义（Role Definitions）。这些噪音（有的甚至会带来不必要的约束）会使得 AI 失去了原本丰富而强大的能力。

*   **摆脱上下文污染**：在长对话中，Cursor 的 Session 积累了大量的试错历史、代码片段、错误日志。这些噪音会形成思维惯性，导致 AI 陷入局部最优解。

*   **强制结构化总结**：邮件的格式要求 AI 必须将**目标、现状、报错日志、配置文件**进行结构化梳理。这个过程本身就是一种"橡皮鸭调试法（Rubber Ducking）"。

*   **旁观者清**：将这封包含完整信息的邮件，投喂给一个**完全干净的外部环境**。外部模型没有 Cursor 的历史包袱，也没有复杂的 Agent 工具干扰。它们看到的只有你提供的"事实（Context Dump）"。

**最佳实践**：将生成的邮件内容复制给 **Gemini 1.5 Pro**（或 Claude 3.5 Sonnet 等具备长窗口能力的 SOTA 模型），使用以下 Prompt：

> `请分析以下错误日志和上下文，给出具体的修复代码块，不要解释原因。`

获得基于纯粹逻辑的建议后，粘贴回 `NEXT_STEP.md`，让 Cursor 执行修复。

### 2. 突破终端封锁 (The Stdin Block)

**问题**：Cursor 的集成终端经常拦截或禁用标准输入（stdin），导致交互脚本无法接收用户指令。

**解决方案**：放弃不稳定 stdin，改用 **文件监听 (File Watcher)**。脚本会生成一个 `NEXT_STEP.md` 文件，用户只需修改并保存该文件，脚本即可捕捉指令。

**技术革新**：相比旧版 Python `input()` 方案，本方案使用**文件监听**，完美绕过了 Cursor 终端拦截键盘输入 (stdin) 的限制，极其稳定。

### 3. 防止进程假死 (The Timeout Kill)

**问题**：IDE 会强制杀死长时间无输出的进程，导致循环中断。

**解决方案**：脚本内置 **Anti-Timeout Spinner (心跳保活)**，在终端持续打印动态进度条，欺骗 IDE 认为进程处于活跃状态，从而实现"无限挂起"。

---

## 🔥 核心能力详解

### 1. 无限续杯 (The Infinite Loop)

**解决痛点**：Cursor 每月 500 次 Fast Request 配额用完即止。

**原理对比**：

```
┌─────────────────────────────────────────────────────────────┐
│                    传统模式                                   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  用户输入 ──> AI 回复 ──> 结束对话 ──> ❌ 消耗 1 Request      │
│                                                               │
│  (每次对话都消耗 1 个 Request)                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    10x 模式                                   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  用户输入 ──> AI 执行任务 ──> 运行脚本挂起                   │
│                                                               │
│       ▲                                    │                 │
│       │                                    ▼                 │
│       │                            用户修改文件              │
│       │                                    │                 │
│       │                                    ▼                 │
│       └────────── AI 继续工作 ◄────────────┘                 │
│                                                               │
│  ✅ 消耗 1 Request (无论循环多少次)                          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**核心优势**：
- **传统模式**：每次对话 = **消耗 1 个 Fast Request**
- **10x 模式**：无论循环多少次（只要不关闭 Session），通常**只消耗 1 个 Fast Request**（主要消耗的是 Token，而非 Request 次数）

**技术实现**：使用文件监听代替不稳定的终端输入，并利用动态进度条防止 IDE 因超时杀死进程。

### 2. 咨询师模式 (The Consultant)

**解决痛点**：AI 在同一个 Bug 上反复尝试，陷入局部最优解，浪费上下文窗口。

**工作流程**：

```
┌──────────────┐   ┌──────────┐   ┌──────────┐   ┌──────────────┐   ┌──────────────┐
│AI遇到顽固错误│──>│陷入循环?  │──>│  是      │──>│触发咨询师模式│──>│生成咨询邮件  │
└──────────────┘   └─────┬────┘   └──────────┘   └──────────────┘   │(目标/错误/代码)│
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │用户复制邮件  │
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │发送给外部模型│
                         │                                         │Gemini/Claude │
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │外部模型分析  │
                         │                                         │(干净的建议)  │
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │粘贴到NEXT_STEP│
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │Cursor读取建议│
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │打破思维定势  │
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │一次性修复问题│
                         │                                         └──────┬───────┘
                         │                                                │
                         │                                                ▼
                         │                                         ┌──────────────┐
                         │                                         │✅ 问题解决    │
                         │                                         └──────────────┘
                         │
                         └──> [否] ──> ┌──────────────┐
                                       │继续正常流程  │
                                       └──────────────┘
```

**详细步骤**：

1.  **触发**：当 AI 遇到顽固报错或无法决策时。

2.  **起草**：AI 根据规则，自动在对话框中生成一封**结构化的咨询邮件**（包含日志、代码、上下文）。

3.  **求助**：你复制这封"邮件"，发送给更强大的推理模型（如 **Gemini 1.5 Pro**, **Claude 3.5 Sonnet** 或 **DeepSeek R1**）。

4.  **回填**：将外部模型的建议粘贴回 `NEXT_STEP.md`。

5.  **解决**：Cursor 读取外部建议，打破思维定势，一次性修复问题。

---

---

## ❓ 常见问题 (FAQ)

**Q: 为什么需要这些运行时？**

A: 本项目支持多种运行时，**所有版本功能相同**。建议优先使用系统自带的版本（PowerShell/CMD/Shell），无需额外安装。如果你已安装 Bun、Node.js 或 Python，也可以使用对应版本。

**Q: 长时间挂起会断开连接吗？**

A: 会。如果挂起超过一定时间（通常 2-5 分钟，取决于 IDE 设置），云端连接可能会断开。建议在 2-5 分钟内完成 `NEXT_STEP.md` 的回复。

**Q: 这个方案消耗 Token 吗？**

A: **是的**。虽然节省了 Request 次数，但长对话会积累大量的 Token。请留意你的 Token 使用量，并在适当的时候开启新的 Session。

**Q: 规则文件未生效怎么办？**

A: 如果发现规则未生效，可以：
1. 手动将规则文件内容添加到对话上下文中
2. 直接在对话中引用规则文件（如：`@cursor-rules.mdc`）
3. 确认 Cursor 设置中的 "Rules for AI" 已启用
4. 检查规则文件是否在正确的位置（`.cursor/rules/` 或根目录的 `.cursorrules`）

---

## 🔧 故障排除 (Troubleshooting)

### 脚本报错 "Permission denied"

**问题**：Linux/macOS 下运行脚本时提示权限不足。

**解决方案**：
```bash
chmod +x ask-followup.sh  # 或 ask-followup.py
```

### AI 没有自动运行脚本而是直接回话了

**问题**：AI 完成任务后没有运行脚本，而是直接回复。

**解决方案**：
1. 检查规则文件是否被正确读取：在对话中输入 `@cursor-rules.mdc` 确认
2. 手动提示 AI：`请运行 ask-followup.* 脚本`
3. 确认你使用的是 **Composer Agent 模式**，不是普通聊天模式

### Windows 下中文乱码

**问题**：Windows 下脚本输出中文显示为乱码。

**解决方案**：
- PowerShell：确保脚本文件编码为 UTF-8（无 BOM）
- CMD：可能需要设置代码页：`chcp 65001`

### 规则文件未被识别

**问题**：Cursor 没有读取规则文件。

**解决方案**：
1. 确认文件位置：`.cursor/rules/cursor-rules.mdc` 或根目录的 `.cursorrules`
2. 检查文件格式：确保是 `.mdc` 或 `.cursorrules` 扩展名
3. 重启 Cursor 让规则生效
4. 在 Cursor 设置中确认 "Rules for AI" 功能已启用

---

## 💝 支持

如果你觉得这个工具有用，可以通过以下方式打赏支持我：

*   在 [Ko-fi](https://ko-fi.com/helloxlxz) 请我喝杯咖啡

## 🤝 贡献

如果你有其他运行时版本的需求或更多建议，欢迎提交 Issue 或 Pull Request！

---

## 📄 许可证

MIT
